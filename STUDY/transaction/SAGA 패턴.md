# SAGA 패턴

- **이벤트 방식(Async, 큐잉)** 으로 **트랜잭션에 포함된** 여러 작업 (각 서비스의 API Call)의 결과를 게시하고, 
- 이벤트를 비동기 처리하여 다음 작업들을 진행
  - 실패시 역순으로 보상 트랜잭션 작업을 호출한다면?? (Undo)
    - e.x. 트랜잭션 예시 : 작업1 -> 작업2 -> 작업3 -> 작업4 가 하나의 트랜잭션으로 묶인 경우

#### 정상적인 상황 
- 정상적으로 작업1을 실행 후 "성공" 이벤트를 개시
- consume 후, 다음 서비스가 정상적으로 작업 2을 실행
- consume 후, 다음 서비스가 정상적으로 작업 3을 실행
- consume 후, 다음 서비스가 정상적으로 작업 4을 실행
- 작업 4 정상 "성공" 이벤트를 게시  **-> 여기서 보통 고객에게 OK 응답 내림**
- 작업 3을 진행한 서비스가 consume, 작업 3 "성공" 이벤트 개시 
- 작업 2을 진행한 서비스가 consume, 작업 2 "성공" 이벤트 개시 
- 작업 1을 진행한 서비스가 consume, 작업 1 "성공" 이벤트 개시 -> 트랜잭션 완료


### 우리 페이에서의 송금 서비스 예시 

- 송금 시작 이벤트 (**머니 서비스 작업 시작**) 게시
- -> 머니 컨슘 
  - 잔액이 충분한지 아닌지 처리 후 
  - 결과 이벤트 게시
    - -> 뱅킹 컨슘, 펌뱅킹 실행
      - 이벤트 결과에 따른 처리 후 결과 게시
        - -> 머니 컨슘
          - 정상이라면 잔액 증가 
          - **실패라면? 이때는 어떡하징**


## SAGA 패턴의 종류 
- Saga 패턴을 구현하는 방법에는 크게 2가지 

### 코레오그레피 (Choreography) 패턴
- 독립적인 조율자 (Ochestrator)를 두지 않고, Saga를 구현하는 방법
- 구현이 비교적 간단하지만, **트랜잭션 상황을 모니터링 하기 어렵다는 단점**
- 비즈니스가 조금이라도 복잡하면 선택 X 

### 오케스트레이션(Orchestration) 패턴
- 독립적인 조율자(Orchestrator)를 두어, 하나의 Saga(트랜잭션)에 대한 매니징을 담당하는 방법
- 구현이 비교적 어렵지만, **비교적 전체적인 트랜잭션의 모니터링이 수월하다는 장점**


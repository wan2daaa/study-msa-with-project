# 우리 페이 시스템에서 트랜잭션이 필요한 구간 식별_ 충전, 송금


## 현재 시스템에서 문제는 무엇일까?

### 분리, 분해로 생긴 문제 - 트랜잭션

- 복잡한 비즈니스를 만족시켜야 하는 트랜잭션은 아직 만족시키지 못한 상태!

**가장 좋은 방법은, 트랜잭션 구현을 위한 패턴을 쓰지 않는것**

- ->추가 인프라, 인력, 모니터링, 비즈니스의 중요성을 고려

- 그렇다면 충전, 송금 서비스에 기교(skill)를 부려볼 만한지 판단 해보자.
    - 재시도 (+Dead Letter Queue)
    - DB에 실행상태 (Status)를 기록

#### 충전 Case

1. 회원 확인 (Membership Service) - Read
    - 실패시 종료하면 됨 (Read 이기 때문에 큰 문제 발생 안할 것)
2. 펌뱅킹 요청 (Bank Service) - **Write**
    - 고객 연결 계좌에서 우리 페이 법인계좌 이체 요청
3. 성공 후, Money DB update - **Write**

- **펌뱅킹 요청은 성공했지만, Money DB에 문제가 생길 경우**

##### 충전 Case에 트랜잭션 대신 다른 방법을 써보자

**재시도 (+Dead Letter Queue)를 통해 해결**
- DLQ(Dead Letter Queue)란?
    - 여러번 재시도 후에도, 실패한 작업이 들어가는 큐
- **재시도를 할때 주의할 점!**
    - 부하를 받는 상황은 아닐까?
    - 일시적인 문제일 가능성이 높을까?
    - 장애 지속시간이 얼마나 될까?
    - 짧은 시간 내 재시도 하더라도 괜찮은 비즈니스 인가?
    - 큐잉 인프라가 존재하나?
    - 모니터링을 수월한가?

**DB에 실행 상태(Status)를 기록**
- **DB 상태 기록을 통한 트랜잭션 구현 주의할 점**
    - RDB의 힘을 빌리는 가장 쉬운 구현방법
    - RDB에 부하가 없을지?
    - RDB에 충분한 리소스가 존재하는 상황인가?
    - DBA, SQL 튜닝등 충분한 계획이 갖춰져 있는가?


> 고객 영향도 : 실 계좌에서는 출금되고, 머니는 미충전? **심각한 상황**


#### 송금 Case
1. 회원 확인 (Membership service) - Read
    - 실패시, 종료
2. 머니 잔액 확인 (Money service) - Read
    - 충분할 시 -> 머니 이동 요청(Money Service) - Write
    - 부족할 시 -> 뱅킹을 통한 충전 요청(Bank Service) - Write
        - 펌뱅킹 완료후 -> 머니 이동 요청(Money Service) - Write
            - Money의 이동은 Local Transaction

##### 송금 Case (요청 금액보다 머니 잔액이 부족한 경우)


**재시도 (+Dead Letter Queue)를 통해 해결**
- DLQ(Dead Letter Queue)란?
    - 여러번 재시도 후에도, 실패한 작업이 들어가는 큐
- **재시도를 할때 주의할 점!**
    - 부하를 받는 상황은 아닐까?
    - 일시적인 문제일 가능성이 높을까?
    - 장애 지속시간이 얼마나 될까?
    - 짧은 시간 내 재시도 하더라도 괜찮은 비즈니스 인가?
    - 큐잉 인프라가 존재하나?
    - 모니터링을 수월한가?

**DB에 실행 상태(Status)를 기록**
- **DB 상태 기록을 통한 트랜잭션 구현 주의할 점**
    - RDB의 힘을 빌리는 가장 쉬운 구현방법
    - RDB에 부하가 없을지?
    - RDB에 충분한 리소스가 존재하는 상황인가?
    - DBA, SQL 튜닝등 충분한 계획이 갖춰져 있는가?


> 고객 영향도 : 출금이 되어, 머니 충전은 되었지만, 송금은 실패!
>
> 음,, 나중에 다시 출금하자 -> 비즈니스적으로 이득


##### 트랜잭션을 구현할지 말지 고민할 때 판단 할 부분

- 트랜잭션의 atomic 속성을 쪼개도 괜찮을지?
- atomic 속성이 깨졌을 경우. 가능한 고객 영향도 체크하기! 감당 가능한 비즈니스 인지

- 충전 서비스에서는 트랜잭션을 위해 Saga 패턴을 적용하자!


# 결론

합리적인 판단 근거를 가지고, 우리는 엔지니어링적으로 트랜잭션을 구현할 필요를 느꼈다

-> 비즈니스, 내부인력, 인프라 등 다양한 요인을 종합적으로 판단

이를 위해, EDA를 직접 구현해 볼 수 있지만, Risk가 너무 크기 때문에 오픈소스를 선택 !

-> Axon Framework

트랜잭션 구현에 필요한 서비스들을 EDA 방식으로 Refactoring 할 필요성을 느끼고, 이를 진행하기로 결정 

-> Banking , Money Service Refactoring

> Axon Framework 기바의 EDA를 사용해서, "충전"을 위한 Saga를 정의하고 개발해보자!

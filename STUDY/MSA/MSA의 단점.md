
## MSA의 단점

### 분산시스템이 어려운이유1_IPC

##### 모놀리식에서의 모듈, 서비스 간 통신 1 - 개발/ 운영 측면
- 다른 서비스를 호출하기 위한 인터페이스, 클라이언트 메서드를 호출

`Spring <-> Middleware(JPA, Mybatis...) <-> DB`

- 성공시 Happy, 실패시에도? 내가 할수 있는 것은?
- 로깅? 모니터링? 관련 부서에 전화부터?
- 트러블 슈팅을 하기 위해서는 개발자를 이 프레임워크와 회사에서 일하는 AA/TA/DA에게 어디서 부터 해결해야하는지 요청을 해야할 것
- 모놀리식 환경에서는 스프링만 알아도 일반적인 로직을 작성할 때 문제가 되지 않기 때문

##### 모놀리식에서의 모듈, 서비스 간 통신 2 - 빌드, 배포 측면
- 빌드, 배포 시 하는 일
    - Jenkins Job Run
        - dependency check
        - gradle build
        - ssh test
        - health check ok
        - 만약 에러가 터진다면?
            - 보통은 회사의 Devops를 부름 -> 개발자 입장에서는 스프링 부트 로직만 작성하면됨

- Alpha 환경을 다른 부서에서 사용중이라면? 혹은 Build 실패해도 이 모든 것을 이해할 수 없음
- 배포, 즉 Graceful Shutdown & Run을 위한 스크립트 작업


#### MSA 환경에서 서비스 간 통신 1 - 개발/운영 측면
- 다른 서비스를 호출하려면 타 서비스를 호출을 위한 통신(HTTP/gRPC)을 활용
    - gRPC, HTTP 에 대한 기본적인 이해 필수 요소
        - (e.x. Keepalive? Connection Pool? Connection/Business Logic Timeout 차이? )
        - 위와 같은 문제가 발생해도 개발자가 직접 해결해야함!
            - Connection Timeout 이면 방화벽 문제일 가능성 높음

#### MSA 환경에서 서비스 간 통신 2 - CI/CD 측면
- 지속적인 통합과 배포(CI/CD) 환경에서, 현재 Production 상황은 어떤지? 나의 feature가 포함되어 있는지?
- Devops, SRE가 책임질 수 있는 부분들에게는 한계가 존재
- Logging, Monitoring 등 어느정도 비즈니스 로직 전반에 대해 각 서비스 간 동작 방식을 알아야만 트러블 슈팅 등이 가능하다.


> 지금까지 모놀리식 환경에서는 DBA나 Devops 분들이 다 확인해주지만,
>
> MSA 환경에서는 알아야 할 부분이 많다! 더 많이 이해해야하고, 더 많이 알아야 한다



### 분산시스템이 어려운이유2_Transactions

##### 모놀리식 환경에서의 트랜잭션
1. 고객이 송금을 요청한다.
2. 일단 고객 상태가 정상인지 확인한다.
3. 송금 요청한 시점을 기록한다. (Write)
4. 은행에 해당 계좌가 정상인지 확인한다.
5. 송금 게좌의 정상 여부를 기록한다. (Write)
6. 송금 요청을 한다.
7. 최종 성공 여부를 기록하고, 결과를 리턴한다. (Write)

- 모놀리식 트랜잭션을 위해 개발자에게 필요한것
    - SpringBoot @Transaction
    - DB Resources

#### MSA 환경에서의 트랜잭션
1. 고객이 송금을 요청한다.
2. 일단 고객 상태가 정상인지 확인한다.
3. 송금 요청한 시점을 기록한다. (Write- 송금 DB)
4. 은행에 해당 계좌가 정상인지 확인한다.
5. 송금 게좌의 정상 여부를 기록한다. (Write- 계좌 확인 서비스) -> 기록을 하다가 실패하면? -> 3번 Process로 Rollback 필요!
6. 송금 요청을 한다.
7. 최종 성공 여부를 기록하고, 결과를 리턴한다. (Write)
8. 만약 다 건 송금 요청이라면..? / 송금이 아니라 충전 과정으로 가정, 이후에 결제 과정까지 이루어져야 한다면..?

- MSA 트랜잭션을 위해 개발자에게 필요한것
    - 보상 트랜잭션 - Saga (5번프로세스 실패했을 때 부분)
    - 2PC (two phase commit)

#### Data Query의 어려움
- 2023년 5월 6일 부터 2023년 5월 8일 까지 외부 계좌 확인에 대해서 성공했지만, 잔액이 부족하여 실패한 송금요청은 얼마나 발생했지?

##### 모놀리식
- 각각의 요청들에 대해서 모두 한 DB에 저장되어 있어서 requestId에 따라 SQL을 짜면 됨!

##### MSA 환경에서라면..?
- 계좌 확인 서비스 DB :  2023년 5월 6일 부터 2023년 5월 8일 까지 외부 계좌 확인에 대해서 성공했지만
- 송금/충전 서비스 DB :  잔액이 부족하여 실패한 송금요청은 얼마나 발생했지?
- request 는 앞단에서 또 계산 해야함

- MSA 환경으로 온다면, API 조합 패턴, CQRS

### 분산시스템이 어려운이유3_Monitoring

##### 모놀리스 환경에서의 모니터링

- 모니터링의 대상
    - Infra(서버, DB)의 상태(CPU, Memory...)
    - 네트워크 Status(Inbound / Outbound Proxt Latency ...)
    - 어플리케이션 상태 (JVM Status, App Warning, Error...)


- 이런 데이터를 프로메테우스로 보내지고, 시계열 DB로 보내짐
    - 이것을 Grafana 로 확인하게 됨

#### MSA/Cloud 환경에서의 모니터링
- 모니터링의 대상
    - 각각의 노드 정보들, for Monolithics(인프라, 앱 상태...)
    - 서비스 간 응답, 네트워크 상태(Latency, Error rate,...)
    - 어떤 트랜잭션이 어느 구간에서 왜 문제가 발생했는지??!

- 프로메테우스에서 Pull 방식을 쓸 수 있고, Push도 쓸 수있다.프로메테우스 입장에서
    - Pull 방식 : 일반적인 방식 (어플리케이션에게 메트릭을 요청해서 가져오는 것)
        - 포트만 열어주면 프로메테우스가 알아서 가져가서 부하도 적고 **보통 많이 사용함**
    - Push 방식 : 프로메테우스가 가져오다 보니 주기적으로 Polling 방식임 (어플리케이션이 보내는 것)
        - cron job 방식에서는 보통 push 방식을 사용함

### 분산시스템이 어려운이유... 결론

- MSA(분산 시스템)은 난이도가 높다
- 통신, 트랜잭션, 모니터링 등 굵직하고 해결하기 어려운 문제들이 많다.
    - 그러나 , AWS, Cloud 기반 기술 (Docker, K8S) 등의 등장으로 많은 부분들이 해결되었다.
    - MSA 환경에서 모니터링을 위한 다양한 기술 스택이나 이론도 많이 나왔다. (Jaeger, Kiali, Zipkin-Circuit Breaker ...)

- 그럼에도 전체적인 동작 방식이나 구조를 이해해야만 Business Capabilities를 챙길 수 있다.
# 분해로 인해 생겼던 다양한 문제들을 어떻게 해결 하나요

## 발생가능한 문제들 1

**요청에 대한 처리량이 급격히 하락**
- 각 서비스의 정확한 필요한 컴퓨팅 리소스 파악 어려움
- 필요한 컴퓨팅 자원의 최적화 어려움 -> 성능 하락 가능성 

> **특정 서비스들의 비즈니스 도메인 특성을 프로그래밍과 연계하여 정확히 파악**
> 
> -> **어느 서비스에서 얼마나 자원이 필요할지 파악**

---

**통신(http,grpc 프로토콜 상의 이슈, 큐잉) 으로 인해 디버깅 어려움**
- Connection Pool 관리
- 만약 JVM의 한정된 리소스로 잘 사용하였는데, JVM 최적화가 더 어려워짐
  - 의도치 않은 결과 발생 가능성
- http, grpc 프로토콜에 디펜던시가 있는 지식 필요
  - Connection Timeout, tcp-3handshake 이해, grpc code, ...

> **프로토콜 및 통신과 관련된 프로그래밍 및 언어 기반 지식**
> 
> **이러한 문제들을 실제로 경험해보고 대용량 MSA 환경에서 디버깅 경험** 


> **여러가지 문제를 해결해주는 MSA 패턴으로 해결할 수 있는 영역이 아님!**
---

### 그러나 **"분해" 라는 행동으로 인해 생기는 1차적인 문제**는 해결해야 함
- -> 한정된 갯수의 서버와 서비스(프로세스)의 갯수
  - -> 수 많은 관리해야 할 서버와, 수 많은 서비스들을 어떻게 배포하고 관리?? 
    - -> **Container! (docker)**
  - -> 많은 컨테이너는 또 어떻게 관리? 
    - -> **Container Ochestration (k8s)**
      - k8s, Docker(Containerizing)를 이용한 컨테이너 오케스트레이션!

> 컨테이너들을 관리한다는 측면에서 Docker-Compose와 유사하지만 훨씬 더 복잡하고 다양한 기능을 지원


## 발생 가능한 문제들 2 

- hop이 늘어남에 따라, **어디서 어떤 요청에 대한 문제가 발생** 했는지 어려움
  - 서비스의 갯수가 늘어가면서, 어느 요청에서 문제가 발생했는지? 

> Tracing 으로 해결 가능

- **로그 수집**을 위한 별도의 인프라 필요 및 관리 필요성
  - 비교적 간단한 로깅 파이프라인
  - 굉장히 복잡하고, 처리해야할 많은 문제들 발생 (e.x. 누락)

> Logging 과 관련된 부분들이 있다

- 수십,수백개의 서비스에 대해 **JVM/하드웨어 얼마나 정상적인지 지속적인 확인** 필요
  - 서비스 또는 서버에 문제가 생기더라도 적절하게 문제 감지 어려움

> Metric, Alert 

- **어느 서비스에서 어느 서비스로 호출이 되어야 하는지**, 이게 정상인지 확인 필요
  - 서비스 간 호출 상태가 옳은 상태인지, 엉뚱한 서비스를 호출하지는 않는지 파악 어려움

> Service-Mesh 


## MSA 환경에서의 모니터링 (로깅, 메트릭, 얼럿, 트레이싱, 서비스 메시)

올바른 사용 예 (일반적인)


1. 특정 **Metric**에 사전 정의 되어진 **Alert**를 통해서, 문제를 감지 // 확인이 필요한 **상황 발생** (e.x. DB 정합성 문제 발생 감지)
2. 어떤 Metric에 대한 문제인지를 파악하고, 어떤 행동을 해야할 지 판단
   - 2-1. Metric 수치를 보고 오판단, 혹은 당장 이슈의 정도가 미미하다면 Alert 조건 등을 수정. 코드 수정
   - 2-2. 어플리케이션 레벨의 문제라고 판단 시, Log를 확인
     - 2-2-1. 단순 로그로 확인이 어려울 시, 해당 트랜잭션에 대한 **Tracing** 확인
   - 2-3. 인프라 수준의 문제라면, 정확한 원인 파악 필요 (e.x. CI/CD 과정에서의 문제, OOM Killed 등 )
   - 2-4. 라우팅, 트래픽 등에 문제라면, **Service-Mesh**를 통해 현재 서비스 간 트래픽 모니터링 상태 확인
3. 같은 문제가 발생하지 않도록 조치


## 각 요소 별로 풀어야 할 문제들과, 이를 해결해주는 여러 스택들 

### 로깅(Logging)
- 수많은 서버(IDC, Cloud)내의 , 수많은 서비스들의 로그들을 적절히 필터링하여 누락 없이 로그 저장소 까지 전송해야함
- 수 많은 로그들을 적절히 인덱싱 하여, 필요 시 빠르게 다양한 조건으로 검색이 가능해야 함!

- e.x. EFK(fluentbit, fluentd), ELK
![efk-stack.png](../image/efk-stack.png)


- log를 쌓으면 1차적으로 각각의 서버의 disk에 쌓임
- 이것을 수집을 해야하는데 이것을 수집해주는데 (e.x. Logstash, fluentbit, fluentd)
- 그다음 Kafka 같은 큐를 이용해서 elastic 에 쌓는다
- elastic은 이를 인덱싱 처리하고, 
- 이를 kibana에서 시각화 하면 된다. 

### 메트릭, 얼럿 (Metric, Alert)
- 수많은 서버(IDC, Cloud)내의, 수많은 서비스 내 메트릭 들을 안정적으로 수집하고, 시계열 방식으로 저장(시계열 DB : 시간의 흐름에 따라서 데이터를 조회하는 것에 최적화 되어있는 DB )
- 다양한 오픈소스의 메트릭을 지원하는 대시보드를 사용
- 원하는 복잡한 형태의 비즈니스 메트릭을 작성하고, 이를 기반으로 적절하게 Alert 조건을 설정할 수 있어야 한다. 
  - e.x. 프로메테우스, InfluxDB : 시계열 DB (몇초마다 Polling 방식으로 가져온다)
- 위의 시계열 DB로 메트릭화 시키고
- 이를 시각화하고, 이를 통해 Alert를 설정할 수있는것이 Grafana 이다!

### 트레이싱 (Tracing)
- 하나의 소스 (트랜잭션)에 대해서, 여러개의 서비스에서 어떤 과정들을 거쳐 수행되었는지 확인해야함
  - 적절한 샘플링과, 보기 좋은 UI등을 제공해야함

- e.x. Jaeger, Zipkin, Tempo


### 서비스 메시(Serive Mesh)

- 어느 서비스가 어느 서비스를 호출하고 있는지, 어디로 트래픽이 어느 정도로 발생하고 있는지 등을 모니터링 할 수 있어야 함!
  - e.x. istio


# 결론 
분해라는 액션으로 인해 생긴 문제들 -> MSA Pattern 이 해결하고자 하는 문제들 

- **원인 : 분해**
- **결과 : 다양한 문제들**
- **해결방법 : MSA Pattern, 패턴을 구현한 다양한 기술 스택들**

- 그중에서도 구체적으로 언제, 어떤 상황에 어떤 통신 패턴(IPC, Inter Process Communication Pattern)을 활용할지




# 분해

## 왜 분해/통합이 어려울까?
- MSA에서 분리/분해의 의미는 **비즈니스 케파를 가질 수 있는 방향으로 서비스를 정의하는 일**
- 각 서비스가 비즈니스 케파를 최대한 가질 수 있도록 적절하게 서비스를 정의하는 일
- 각 서비스 별로 하나의 DB를 가진다는 관점에서, 각 서비스 간 적절한 관계를 통해 비즈니스 케파 확보하는 것이 관건!

> 어떤 기준에 따라서? 어떤 지침에 따라서? 분리/분해/통합 하면 좋을 지가 비즈니스 케파를 가질 수 있을지? 
> 
> -> 비즈니스 동작/ 하위 도메인 패턴이 그 수단이 될 것


### 비즈니스 동작 기준으로 분리 
e.x. "배달 주문" 시스템을 위한 서비스도출 해보기 

- 사용자(액터) 입장에서의 비즈니스 요청 식별 
- "비즈니스 동작" 자체를 각 서비스로 분리

###### 주문 서비스 - 고객 입장 

###### 주문 관리 서비스 - 음식점 입장

###### 배달 서비스 - 회사 입장


#### 비즈니스 동작을 기준으로 분리할 경우
- 비즈니스 동작이 그 자체만으로 매우 중요하거나 복잡하고, 혹은 비즈니스의 변화가 적을 경우 **적절할 수 있다**

**비즈니스 동작 만을 기준으로 한다면?**
- 외부 서비스 의존도가 낮은 비즈니스는 괜찮을 수 있지만, 
  - 다양한/빈번한 외부 서비스 통신이 필요한 서비스에서는 제한적
- e.x. 배달 중개 비즈니스가 생기는 과정을 통해, 배달 중개사와 배달원을 유동적으로 매칭해야 하는 상황이 온다면?
  - **-> 배달 서비스는 단순 매칭이 아닌, 적절한 배달 중개사/배달원 매칭을 효율적으로 해야하는 상황 발생**

---
- 우리의 목적은 비즈니스 케파가 높은 MSA를 위해 서비스를 식별하여 분리/분해/통합 하는 일 
- 비즈니스 동작 기반 -> 경우에 따라 높은 비즈니스 케파를 가지기 어려운 상황 발생!

### 하위 도메인 패턴을 기준으로 (from DDD)
e.x. "배달 주문" 시스템을 위한 서비스 도출해보기 

- **사용자 입장**에서의 비즈니스 요청 식별 
- **비즈니스 동작**에서 도메인 모델을 중신으로 비즈니스 도메인에 초점을 맞추는 방식
  - 비즈니스 동작을 분석하는 것에서부터 시작하는 것은 동일!
- **도메인의 복잡성을 이해**하고, **도메인의 문제를 해결**하는 것에 집중하여 **분리/ 분해의 기준**으로 간주하는 방식

> 즉, MSA 에서의 하위 도메인을 이용한 분리/분해는
> 
> 각 서비스의 비즈니스 케파를 높이기 위해 필요에 따라 "하위 도메인 패턴"별 분리/분해 하는 것이 목적!

#### 하위 도메인을 기준으로 분리하자 
- "주문 서비스" - 고객 입장 
  - -> **주문 접수**
    - 주문을 잘 접수하는 것에 집중 -> 비동기 통신 패턴(큐잉)등의 스택에 집중 
  - -> **주문 결제**
    - 받은 주문에 대한 결제를 잘 하는 것에 집중 -> 외부 결제 모듈의 통신 or 낮은 수수료를 위한 방안 찾는 데 집중 
  - -> **주문 단계에서의 추천**
    - 주문 과정에서 "적절한" 방식으로 추가 상품 구매를 유도 집중 -> AI/머신러닝 활용으로 고객 별 최적화에 집중



---
이러한 하위 도메인 이라는 개념을 패턴화 하여 서비스를 식별한다면

비즈니스 케파가 높은 서비스들을 식별할 수 있다.

## 분리 지침
- "하위 도메인" 패턴은 Bounded Context에 따라 도메인을 분리해야 한다는 원칙
- 그렇다면, Bounded Context 만 만족한다면 무조건 분리해도 되나요? 어디까지 분리해야 하나요?

  - **단일 책임 원칙(SRP, Single Responsibility Principle)**
    - 클래스는 오직 하나의 변경 사유를 가져야 한다.
      - 각 클래스는 하나의 책임을 가져라
  - **공통 폐쇄 원칙(CCP, Common Closure Principle)**
    - 패키지의 클래스들은 동일한 유형의 변경에 대해 닫혀 있어야 한다.
    - 패키지에 영향을 주는 변경을 그 패키지에 속한 모든 클래스에 영향을 끼친다.
    - **동일한 사유로 변경되는 클래스들은 동일 패키지에!**
    - e.x. "주문 결제" 시 항상 결제 이력 업데이트 되는 결제 이력 패키지는 "주문 결제"와 동일한 패키지에!